
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../Git-practices/">
      
      
        <link rel="next" href="../MOM6/">
      
      
      <link rel="icon" href="../assets/ACCESS_icon_HIVE.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>MOM6 generic tracers - ACCESS-OM3-configs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#background" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ACCESS-OM3-configs" class="md-header__button md-logo" aria-label="ACCESS-OM3-configs" data-md-component="logo">
      
  <img src="../assets/ACCESS_icon_HIVE.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ACCESS-OM3-configs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MOM6 generic tracers
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://cbull.info/access-om3-configs/docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Cbull
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ACCESS-OM3-configs" class="md-nav__button md-logo" aria-label="ACCESS-OM3-configs" data-md-component="logo">
      
  <img src="../assets/ACCESS_icon_HIVE.png" alt="logo">

    </a>
    ACCESS-OM3-configs
  </label>
  
    <div class="md-nav__source">
      <a href="https://cbull.info/access-om3-configs/docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Cbull
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ACCESS-OM3 architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Building/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Configurations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CMEPS-coupled configurations
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Coupling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Coupling
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Forcing-data-models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Forcing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Git-practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git practices
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    MOM6 generic tracers
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    MOM6 generic tracers
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fms-coupler-types" class="md-nav__link">
    <span class="md-ellipsis">
      FMS coupler types
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-tracer-flux-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Additional tracer flux handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Additional tracer flux handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schematic-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Schematic summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../MOM6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOM6
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../NUOPC-driver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NUOPC driver
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Quick-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Releases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Releases
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Topography-generation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ACCESS-OM3 Topography Workflow
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Updating-components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Updating components
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fms-coupler-types" class="md-nav__link">
    <span class="md-ellipsis">
      FMS coupler types
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-tracer-flux-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Additional tracer flux handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Additional tracer flux handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schematic-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Schematic summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<p>NOAA-GFDL maintain a number of modules for modelling tracers, implemented via the GFDL “generic_tracer” API. These modules are “generic” in the sense that they can be used by both MOM and GOLD. They include a number of BGC models (BLING, COBALT, ERGOM, TOPAZ, miniBLING) and other useful tracers (e.g. CFC, SF6). The modules can be found <a href="https://github.com/NOAA-GFDL/ocean_BGC/tree/master/generic_tracers">here</a>.</p>
<p>Many of the GFDL generic_tracer modules require coupling with other components of the earth system. For example, BLING carries a number of tracers with associated air-sea gas fluxes, runoff fluxes or wet/dry deposition fluxes. Importantly, the additional fluxes required and associated coupled fields—depends on which/how generic_tracers have been configured for use <em>at runtime</em>.</p>
<p>In the generic_tracer modules, coupling of these additional tracer fluxes is handled via <a href="https://github.com/NOAA-GFDL/FMS/blob/main/coupler/coupler_types.F90">FMS coupler_types</a> which are designed for use with the <a href="https://github.com/NOAA-GFDL/FMScoupler">FMScoupler</a>. Modifications to ACCESS-OM3 (which uses CMEPS/NUOPC for coupling, not FMScoupler) are required to allow the use of coupled generic_tracer modules. These modifications are described here.</p>
<h1 id="background">Background</h1>
<h2 id="fms-coupler-types">FMS coupler types</h2>
<p>In <a href="https://github.com/NOAA-GFDL/FMScoupler">FMScoupler</a>, the handling of tracer fluxes in a fully-coupled system revolves around three related FMS <a href="https://github.com/NOAA-GFDL/FMS/blob/38bfde30e1cb8bf5222410a9c37e71529567bf69/coupler/coupler_types.F90#L365-L372"><code>coupler_1d_bc_type</code></a> data structures in <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/flux_exchange.F90#L594-L605"><code>FMScoupler:flux_exchange_mod</code></a>:</p>
<ul>
<li><code>ex_gas_fields_atm</code>: for atmospheric surface fields associated with tracer fluxes and related parameters</li>
<li><code>ex_gas_fields_ice</code>: for ice top and ocean surface fields associated with tracer fluxes and related parameters</li>
<li><code>ex_gas_fluxes</code>: for tracer fluxes and related fields</li>
</ul>
<p>Together, these structures define the additional tracer fluxes required, the fields needed for their calculation, and the calculation method/parameters to use (defined by the flux type and implementation). A number of flux types and implementations can be used and are described in the <code>/coupler_mod/types/</code> field manager list (see <a href="https://github.com/NOAA-GFDL/FMS/blob/38bfde30e1cb8bf5222410a9c37e71529567bf69/coupler/atmos_ocean_fluxes.F90#L937">here</a> for where this list is defined). There are multiple implementations (i.e. calculation methods) for air-sea gas, air-sea deposition and land-sea runoff flux types. Each flux in the <code>ex_gas_*</code> structures has a type and implementation and is associated with an entry in the <code>/coupler_mod/fluxes/</code> field manager list.</p>
<p>As an example, suppose we require an additional tracer flux <code>"co2_flux"</code> of type <code>"air_sea_gas_flux_generic"</code> and implementation <code>"ocmip2"</code> (<code>”ocmip2”</code> describes a particular method for calculating air-sea gas fluxes). After initialising the <code>ex_gas_*</code> structures with this flux, the relevant entry in the <code>/coupler_mod/types/</code> field manager list is:</p>
<pre><code class="language-bash">air_sea_gas_flux_generic/
      implementation/
            ocmip2/
                  num_parameters = 2
            duce/
                  num_parameters = 1
            johnson/
                  num_parameters = 2
      num_flags = 0
      use_atm_pressure = T
      use_10m_wind_speed = T
      pass_through_ice = F
      atm/
            name[1] = 'pcair'
            name[2] = 'u10'
            name[3] = 'psurf'
            long_name[1] = 'Atmospheric concentration'
            long_name[2] = 'Wind speed at 10 m'
            long_name[3] = 'Surface atmospheric pressure'
            units[1] = 'mol/mol'
            units[2] = 'm/s'
            units[3] = 'Pa'
      ice/
            name[1] = 'alpha'
            name[2] = 'csurf'
            name[3] = 'sc_no'
            long_name[1] = 'Solubility w.r.t. atmosphere'
            long_name[2] = 'Ocean concentration'
            long_name[3] = 'Schmidt number'
            units[1] = 'mol/m^3/atm'
            units[2] = 'mol/m^3'
            units[3] = 'dimensionless'
      flux/
            name[1] = 'flux'
            name[2] = 'deltap'
            name[3] = 'kw'
            name[4] = 'flux0'
            long_name[1] = 'Surface flux'
            long_name[2] = 'Ocean-air delta pressure'
            long_name[3] = 'Piston velocity'
            long_name[4] = 'Surface flux no atm'
            units[1] = 'mol/m^2/s'
            units[2] = 'uatm'
            units[3] = 'm/s'
            units[4] = 'mol/m^2/s'
</code></pre>
<p>the <code>"co2_flux"</code> entry in the <code>/coupler_mod/fluxes/</code> field manager list is something like:</p>
<pre><code class="language-bash">co2_flux/
      flux_type = 'air_sea_gas_flux_generic'
      implementation = 'ocmip2'
      atm_tr_index = 0
      mol_wt = 44.0099500000000
      ice_restart_file = 'ice_bling.res.nc'
      ocean_restart_file = 'ocean_bling_airsea_flux.res.nc'
      param[1] = 9.360000000000000E-007
      param[2] = 9.756100000000000E-006
      flag = NULL
      flux-units = 'mol/m^2/s'
      flux-long_name = 'Surface flux'
      deltap-units = 'uatm'
      deltap-long_name = 'Ocean-air delta pressure'
      kw-units = 'm/s'
      kw-long_name = 'Piston velocity'
      flux0-units = 'mol/m^2/s'
      flux0-long_name = 'Surface flux no atm'
      pcair-units = 'mol/mol'
      pcair-long_name = 'Atmospheric concentration'
      u10-units = 'm/s'
      u10-long_name = 'Wind speed at 10 m'
      psurf-units = 'Pa'
      psurf-long_name = 'Surface atmospheric pressure'
      alpha-units = 'mol/m^3/atm'
      alpha-long_name = 'Solubility w.r.t. atmosphere'
      csurf-units = 'mol/m^3'
      csurf-long_name = 'Ocean concentration'
      sc_no-units = 'dimensionless'
      sc_no-long_name = 'Schmidt number'
</code></pre>
<p>and (assuming <code>ind_co2</code> is the index for the <code>"co2_flux"</code> flux):
- <code>ex_gas_fields_atm%bc(ind_co2)</code> is initialised to carry the fields <code>pcair</code>, <code>u10</code> and <code>psurf</code>
- <code>ex_gas_fields_ice%bc(ind_co2)</code> is initialised to carry the fields <code>alpha</code>, <code>csurf</code> and <code>sc_no</code>
- <code>ex_gas_fluxes%bc(ind_co2)</code> is initialised to carry the fields <code>flux</code>, <code>deltap</code>, <code>kw</code> and <code>flux0</code></p>
<p>During a coupling loop with FMScoupler the fields for each flux in <code>ex_gas_fields_atm</code> and <code>ex_gas_fields_ice</code> are set and the fluxes in <code>ex_gas_fluxes</code> are calculated from these fields. <strong>Importantly, the arrays in the <code>ex_gas_*</code> structures are 1-dimensional (<code>coupler_1d_bc_type</code>). They will store the fields on the exchange grid used in FMScoupler.</strong></p>
<h2 id="additional-tracer-flux-handling">Additional tracer flux handling</h2>
<p>A (greatly) simplified summary of the handling of additional tracer fluxes in FMScoupler is as follows:</p>
<ul>
<li>Initialise <code>ex_gas_fields_atm</code>, <code>ex_gas_fields_ice</code> and <code>ex_gas_fluxes</code> for the additional tracer fluxes. This step calls initialisation routines within the ocean and atmosphere models to determine what additional tracer fluxes are required. No field arrays set at this point. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L1689"><code>gas_exchange_init</code></a>).</li>
<li>Spawn a 2D version, <code>Ocean%fields</code> (<code>coupler_2d_bc_type</code>), of <code>ex_gas_fields_ice</code>. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L1801"><code>ocean_model_init</code></a>)</li>
<li>Calculate/set field arrays for <code>alpha</code>, <code>csurf</code> and <code>sc_no</code> for air-sea gasfluxes in <code>Ocean%fields</code>. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L1801"><code>ocean_model_init</code></a>)</li>
<li>Spawn a 2D version, <code>Atm%fields</code>, of <code>ex_gas_fields_atm</code>. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L1857"><code>flux_exchange_init</code></a>)</li>
<li>Spawn a 2D version, <code>Ice_ocean_boundary%fluxes</code>, of <code>ex_gas_fluxes</code>. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L1857"><code>flux_exchange_init</code></a>)</li>
<li><strong>&gt;&gt;&gt; Begin coupling loop</strong></li>
<li>Set arrays for <code>pcair</code> (air-sea gas fluxes) and <code>deposition</code> (air-sea deposition fluxes) in <code>Atm%fields</code>. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L789"><code>atmos_tracer_driver_gather_data</code></a>)</li>
<li>Set arrays for <code>u10</code> and <code>psurf</code> for air-sea gas fluxes in <code>Atm%fields</code>. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L795"><code>sfc_boundary_layer</code></a>)</li>
<li>Map <code>Ocean%fields</code> and <code>Atm%fields</code> onto exchange grid to set 1D fields in <code>ex_gas_fields_ice</code> and <code>ex_gas_fields_atm</code>, respectively. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L795"><code>sfc_boundary_layer</code></a>)</li>
<li>Calculate fluxes <code>ex_gas_fluxes</code> from <code>ex_gas_fields_ice</code> and <code>ex_gas_fields_atm</code> according to flux types and implementations. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L795"><code>sfc_boundary_layer</code></a>)</li>
<li><strong>Update atmosphere</strong> (this is actually done in multiple steps within a fast coupling loop, but here we’ve simplified)</li>
<li>Map 1D <code>ex_gas_fluxes</code> fields onto 2D <code>Ice_ocean_boundary%fluxes</code> (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L857"><code>flux_down_from_atmos</code></a> and <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L907"><code>flux_atmos_to_ocean</code></a>)</li>
<li><strong>Update land</strong> (this is actually done in multiple steps across two coupling loops, but here we’ve simplified)</li>
<li><strong>Update ice</strong> (this is actually done in multiple steps across two coupling loops, but here we’ve simplified)</li>
<li><strong>Update ocean</strong>, applying <code>Ice_ocean_boundary%fluxes</code>. Calculate/set field arrays for <code>alpha</code>, <code>csurf</code> and <code>sc_no</code> for air-sea gas fluxes in <code>Ocean%fields</code>. (via <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/coupler_main.F90#L1063"><code>update_ocean_model</code></a>)</li>
<li><strong>&lt;&lt;&lt; End coupling loop</strong></li>
</ul>
<h3 id="schematic-summary">Schematic summary</h3>
<p>The schematic below traces the handling of additional tracer fluxes in more detail and shows where simplifications were made in the above summary. Note that I generated this schematic by reading the source code and it hasn’t (yet) been verified by any FMScoupler developer. To the best of my knowledge it is mostly complete/correct but I make no guarantees.</p>
<p><img src="https://github.com/dougiesquire/access-om3/assets/42455466/001ba241-1ae8-4bb0-99b1-b63b5569f85b" width=100%></p>
<h1 id="nuopc-coupled-mom6-and-generic_tracers">NUOPC-coupled MOM6 and generic_tracers</h1>
<p>Code changes are required to allow the use of coupled generic_tracers with NUOPC-coupled MOM6. These changes are guided by the following design principles:</p>
<ul>
<li>Use exisiting code where possible, with as little change as possible</li>
<li>Avoid making edits to source code in MOM6 or GFDL generic_tracer modules</li>
</ul>
<p>The code changes are limited to the <a href="https://github.com/NCAR/MOM6/tree/d363034fcc99eef960889b613b4144df8d8eea5a/config_src/drivers/nuopc_cap">MOM6 NUOPC cap</a> and broadly do as follows:</p>
<ol>
<li>Initialisation phases<ol>
<li>Initialise <code>coupler_1d_bc_type</code> data structures <code>ex_gas_fields_atm</code>, <code>ex_gas_fields_ocn</code> and <code>ex_gas_fluxes</code>. Note these structures are never actually populated with data (unlike in FMScoupler) - they are just used to spawn 2D structures (<code>coupler_2d_bc_type</code>).</li>
<li>Initialise ocean model with (a pointer to) <code>ex_gas_fields_ocn</code> to populate relevant fields.</li>
<li>Spawn 2D <code>Ice_ocean_boundary%fluxes</code> from (a pointer to) <code>ex_gas_fluxes</code>.</li>
<li>Spawn 2D <code>atm_fields</code> from (a pointer to) <code>ex_gas_fields_atm</code>.</li>
<li>Using (a pointer to) <code>ex_gas_fluxes</code>, register with NUOPC the additional atmospheric import fields required flux calculations. Field export has not yet been implemented.</li>
</ol>
</li>
<li>Advance phase<ol>
<li>Get/set atmospheric fields in <code>atm_fields</code> from the coupler.</li>
<li>Calculate the fluxes in <code>Ice_ocean_boundary%fluxes</code> using a modified version of the routine used by FMScoupler that operates on FMS <code>coupler_2d_bc_type</code> inputs.</li>
</ol>
</li>
</ol>
<p>The additional fluxes will be applied from <code>Ice_ocean_boundary%fluxes</code> when the model is advanced.</p>
<h2 id="code-structure">Code structure</h2>
<p>The most important changes made include modifications to:</p>
<ul>
<li><code>MOM6/config_src/drivers/nuopc_cap/mom_cap.F90</code></li>
<li><code>MOM6/config_src/drivers/nuopc_cap/mom_cap_methods.F90</code></li>
</ul>
<p>and the addition of a new module to the NUOPC cap: <code>mom_cap_gtracer_flux.F90</code></p>
<p>Code modifications/additions have been made via patch files found in the <code>MOM6/patches</code> directory. The new module can be found in the <code>MOM6/extra_sources</code> directory.</p>
<h3 id="the-mom_cap_gtracer_flux-module">The <code>mom_cap_gtracer_flux</code> module</h3>
<p>This is where most of the new code is, with many of the changes to <code>mom_cap.F90</code> and <code>mom_cap_methods.F90</code> being calls to routines defined here. This module also includes the data structures <code>ex_gas_fields_atm</code>, <code>ex_gas_fields_ocn</code> and <code>ex_gas_fluxes</code>. Public routines are:</p>
<ul>
<li><code>gas_exchange_init</code>: initialise <code>ex_gas_fields_atm</code>, <code>ex_gas_fields_ocn</code> and <code>ex_gas_fluxes</code> and optionally returns pointers to them.</li>
<li><code>gas_fields_restore</code>: restore an FMS <code>coupler_2d_bc_type</code> state from the ocean restart file defined internally.</li>
<li><code>gas_fields_restart</code>: write restart for an FMS <code>coupler_2d_bc_type</code> to the ocean restart file defined internally.</li>
<li><code>add_gas_fluxes_param</code>: for each flux in an FMS <code>coupler_2d_bc_type</code>, retrieve the <code>param</code> array from the <code>/coupler_mod/fluxes/</code> field manager list and set it in the <code>coupler_2d_bc_type</code>. This is only needed because spawning a <code>coupler_*d_bc_type</code> does not copy the <code>param</code> array into the spawned type.</li>
<li><code>get_coupled_field_name</code>: provides the CMEPS field standard name of any fields that need to be coupled for a given generic_tracer flux name. Currently only generic_tracer fluxes <code>"co2_flux"</code> and <code>"o2_flux"</code> have been implemented.</li>
<li><code>atmos_ocean_fluxes_calc</code>: calculates the tracer fluxes according to their flux type and implementation. This routine was copied from <a href="https://github.com/NOAA-GFDL/FMScoupler/blob/6442d387153064644325c96a5e9e2935139d5e3c/full/atmos_ocean_fluxes_calc.F90">FMScoupler</a> and modified. Key modifications include:<ul>
<li>Operate on <code>coupler_2d_bc_type</code> inputs, rather than <code>coupler_1d_bc_type</code>.</li>
<li>Include calculation for <code>"air_sea_deposition"</code> flux types (which in FMScoupler is done in a separate step)</li>
<li>Account for sea-ice fraction (in FMScoupler this is done as part of the exchange grid mapping)</li>
<li>Make <code>tsurf</code> input optional, as it is only used by a few implementations</li>
</ul>
</li>
</ul>
<h3 id="schematic-summary_1">Schematic summary</h3>
<p>The schematic below traces the handling of coupled generic_tracer fluxes in the MOM6 NUOPC cap.</p>
<p><img src="https://github.com/dougiesquire/access-om3/assets/42455466/b39aff05-4193-42e9-83f7-cce9cb7a974f" width=65%></p>
<h2 id="diagnostics">Diagnostics</h2>
<p>Diagnostics can be output for the FMS <code>coupler_2d_bc_type</code> fields involved in the handling of the tracer fluxes (flux fields: <code>Ice_ocean_boundary%fluxes</code>, ocean fields: <code>ocean_public%fields</code>, atmos fields: <code>atm_fields</code>). The “model_name” for each type is: flux fields: <code>“ocean_flux”</code>, ocean fields: <code>“ocean_sfc”</code>, atmos fields: <code>“atmos_sfc”</code>. The naming convention for diagnostics of FMS <code>coupler_bc_type</code>s is: <code>&lt;flux_name&gt;_&lt;field_name&gt;_&lt;suffix&gt;</code>, where <code>&lt;suffix&gt;</code> is <code>”_ice_ocn”</code>, <code>”_ocn”</code> and <code>”_atm”</code> for the flux, ocean and atmos fields, respectively. For example, the surface flux field for the <code>”co2_flux”</code> example above is called <code>”co2_flux_flux_ice_ocn”</code>.</p>
<p>The flux and atmos diagnostics are sent immediately after the tracer flux calculation is done, prior to advancing the model. The ocean diagnostics are sent after advancing the model. This means that the flux/atmos diagnostics are not available at Tfinal+dt (whereas the ocean diagnostics are) and the ocean diagnostics are not available at Tstart (whereas the flux/atmos diagnostics are).</p>
<h2 id="data-override">Data override</h2>
<p>FMS data override functionality has been added to allow the tracer fluxes and the contributing atmospheric fields to be overridden via a <code>data_table</code> using the component name <code>"OCN"</code>. The naming convention for overriding fields is as described above. E.g. one could override the atmospheric concentration field for the <code>”co2_flux”</code> example above using the fieldname <code>”co2_flux_pcair_atm”</code></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 ACCESS-NRI
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>